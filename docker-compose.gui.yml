services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.web
    ports:
      - "${WEB_PORT:-8080}:80"
    depends_on:
      - api

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        NETLAB_REF: ${NETLAB_REF:-release_26.01.01}
    ports:
      - "${API_PORT:-8000}:8000"
    depends_on:
      - postgres
      - redis
    extra_hosts:
      - "local-agent:host-gateway"
    environment:
      # Database
      - DATABASE_URL=${DATABASE_URL:-postgresql+psycopg://netlab:netlab@postgres:5432/netlab_gui}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      # Workspace
      - NETLAB_WORKSPACE=${NETLAB_WORKSPACE:-/var/lib/netlab-gui}
      - NETLAB_PROVIDER=${NETLAB_PROVIDER:-clab}
      # Auth
      - LOCAL_AUTH_ENABLED=${LOCAL_AUTH_ENABLED:-true}
      - JWT_SECRET=${JWT_SECRET:-CHANGE_ME_IN_PRODUCTION}
      - SESSION_SECRET=${SESSION_SECRET:-CHANGE_ME_IN_PRODUCTION}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-}
      # Limits
      - MAX_CONCURRENT_JOBS_PER_USER=${MAX_CONCURRENT_JOBS_PER_USER:-2}
      # OIDC (optional)
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID:-}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET:-}
      - OIDC_REDIRECT_URI=${OIDC_REDIRECT_URI:-}
      - OIDC_SCOPES=${OIDC_SCOPES:-openid profile email}
      - OIDC_APP_REDIRECT_URL=${OIDC_APP_REDIRECT_URL:-}
      # Logging
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - LOKI_URL=${LOKI_URL:-http://loki:3100}
    volumes:
      - netlab_workspaces:/var/lib/netlab-gui
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      - "service=api"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  worker:
    build:
      context: .
      dockerfile: Dockerfile.api
      args:
        NETLAB_REF: ${NETLAB_REF:-release_26.01.01}
    command: ["rq", "worker", "netlab"]
    network_mode: host
    privileged: true
    depends_on:
      - redis
      - postgres
    environment:
      - DATABASE_URL=postgresql+psycopg://netlab:netlab@localhost:15432/netlab_gui
      - REDIS_URL=redis://localhost:16379/0
      - NETLAB_WORKSPACE=${NETLAB_WORKSPACE:-/var/lib/netlab-gui}
      - NETLAB_PROVIDER=${NETLAB_PROVIDER:-clab}
      - JWT_SECRET=${JWT_SECRET:-CHANGE_ME_IN_PRODUCTION}
      - LOG_FORMAT=${LOG_FORMAT:-json}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - netlab_workspaces:/var/lib/netlab-gui
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      - "service=worker"

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_USER=netlab
      - POSTGRES_PASSWORD=netlab
      - POSTGRES_DB=netlab_gui
    ports:
      - "15432:5432"
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netlab"]
      interval: 30s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7
    ports:
      - "16379:6379"

  # Optional: Local agent (disable with --scale agent=0 for multi-host setups)
  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    network_mode: host
    pid: host  # Required for overlay networking to access container namespaces
    privileged: true
    depends_on:
      - api
    environment:
      - ARCHETYPE_AGENT_AGENT_NAME=${ARCHETYPE_AGENT_NAME:-local-agent}
      - ARCHETYPE_AGENT_AGENT_PORT=${ARCHETYPE_AGENT_PORT:-8001}
      - ARCHETYPE_AGENT_CONTROLLER_URL=http://localhost:8000
      - ARCHETYPE_AGENT_LOCAL_IP=${ARCHETYPE_AGENT_LOCAL_IP:-}
      - ARCHETYPE_AGENT_ENABLE_CONTAINERLAB=true
      - ARCHETYPE_AGENT_ENABLE_VXLAN=true
      - ARCHETYPE_AGENT_WORKSPACE_PATH=/var/lib/archetype-agent
      - ARCHETYPE_AGENT_LOG_FORMAT=${LOG_FORMAT:-json}
      - ARCHETYPE_AGENT_LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      # Use bind mount so containerlab's paths match between agent and cEOS containers
      - /var/lib/archetype-agent:/var/lib/archetype-agent
      - /var/run/docker.sock:/var/run/docker.sock
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service"
    labels:
      - "service=agent"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8001/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # --- Centralized Logging Stack ---

  loki:
    image: grafana/loki:2.9.0
    ports:
      - "3100:3100"
    command: -config.file=/etc/loki/local-config.yaml
    volumes:
      - loki_data:/loki
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  promtail:
    image: grafana/promtail:2.9.0
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki

  grafana:
    image: grafana/grafana:10.2.0
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_DISABLE_LOGIN_FORM=true
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
    depends_on:
      - loki

volumes:
  netlab_workspaces:
  agent_workspaces:
  pg_data:
  loki_data:
  grafana_data:
